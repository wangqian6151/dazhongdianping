# dz_location = ['r1949', 'r3158', 'r3159', 'r3160', 'r7602', 'r7605', 'r11334', 'r12257', 'r12258', 'r28441', 'r1566',
#                'r3183', 'r7606', 'r8401', 'r7475', 'r7874', 'r8347', 'r6013', 'r7482', 'r7882', 'r12259', 'r12260',
#                'r1563', 'r3173', 'r3174', 'r7480', 'r7607', 'r8399', 'r1560', 'r1562', 'r3167', 'r3172', 'r7875',
#                'r12254', 'r12255', 'r12256', 'r12322', 'r1952', 'r3187', 'r3190', 'r7883', 'r12262', 'r1954', 'r1953',
#                'r7881', 'r12261', 'r7474', 'r8402', 'r38389', 'r1556', 'r3142', 'r3143', 'r3144', 'r3147', 'r3148',
#                'r7876', 'r29', 'r1949', 'r7475', 'r1560', 'r12322', 'r1556', 'r1951', 'r12321', 'r1559', 'r12225',
#                'r1557', 'r1573', 'r12324', 'r12226', 'r12323', 'r3138', 'r12320', 'r12319', 'r1950', 'r31',
#                'r1566', 'r6013', 'r1952', 'r1954', 'r1953', 'r7474', 'r67064', 'r1567', 'r28440', 'r30824', 'r1568',
#                'r12333', 'r12036', 'r8358', 'r8359', 'r30', 'r8347', 'r1563', 'r1562', 'r1574', 'r70137', 'r12330',
#                'r1564', 'r1565', 'r12326', 'r1575', 'r12327', 'r12328', 'r12325', 'r3139', 'r12332', 'r12329', 'r12331',
#                'r23067', 'r83344', 'r32', 'r1572', 'r1571', 'r30534', 'r1955', 'r12033', 'r8651', 'r64803', 'r1956',
#                'r70527', 'r23069', 'r8652', 'r8354', 'r12035', 'r8356', 'r34', 'r8646', 'r1957', 'r1570', 'r12335',
#                'r8647', 'r8357', 'r8355', 'r12334', 'r8648', 'r3141', 'r70631', 'r33', 'r38389', 'r1569', 'r64842',
#                'r38388', 'r38386', 'r64843', 'r64844', 'r38387', 'r64848', 'r8649', 'r8650', 'r64846', 'r8350',
#                'r8349', 'r64802', 'r8353', 'r8351', 'r8653', 'r64845', 'r3140', 'r64847', 'r12034', 'r8352', 'r8348',
#                'r70283', 'r3204', 'r7118', 'r7159', 'r7176', 'r70569', 'r70570', 'r70571', 'r70572', 'r70573', 'r70574',
#                'r70575', 'r70576', 'r70577', 'r70578', 'r70579', 'r70581', 'r70582', 'r70583', 'r70584', 'r70593',
#                'r70594', 'r70282', 'r3217', 'r7152', 'r7165', 'r7171', 'r7174', 'r7179', 'r7207', 'r7231', 'r70538',
#                'r70551', 'r70552', 'r70553', 'r70554', 'r70555', 'r70556', 'r70557', 'r70558', 'r70559', 'r70560',
#                'r70561', 'r70562', 'r70563', 'r70564', 'r70565', 'r70566', 'r70567', 'r70568', 'r70594', 'r82421',
#                'r70284', 'r3204', 'r7145', 'r7162', 'r70538', 'r70540', 'r70541', 'r70542', 'r70543', 'r70544',
#                'r70545', 'r70546', 'r70547', 'r70549', 'r70550', 'r70593', 'r3198', 'r7097', 'r7098', 'r7099', 'r7100',
#                'r7101', 'r7102', 'r7104', 'r7106', 'r7108', 'r7109', 'r7110', 'r7112', 'r7114', 'r7115', 'r3200',
#                'r3201', 'r3202', 'r3203', 'r3205', 'r3206', 'r3207', 'r3208', 'r3209', 'r3210', 'r3211', 'r3212',
#                'r3213', 'r3214', 'r7094', 'r7129', 'r7130', 'r7131', 'r7139', 'r7142', 'r7144', 'r7145', 'r7146',
#                'r7147', 'r7149', 'r7150', 'r7152', 'r7153', 'r7156', 'r7157', 'r7159', 'r7160', 'r7163', 'r7166',
#                'r7167', 'r7168', 'r7169', 'r3216', 'r7095', 'r7170', 'r7173', 'r7175', 'r7177', 'r7178', 'r7180',
#                'r7181', 'r7182', 'r7183', 'r7185', 'r7186', 'r7187', 'r7188', 'r7192', 'r7194', 'r7196', 'r7198',
#                'r7200', 'r7201', 'r7202', 'r7203', 'r7204', 'r3215', 'r3216', 'r3199', 'r7117', 'r7119', 'r7120',
#                'r7121', 'r7122', 'r7123', 'r7124', 'r7125', 'r7126', 'r82240', 'r82241', 'r3215', 'r3218', 'r7096',
#                'r7206', 'r7208', 'r7209', 'r7211', 'r7212', 'r7222', 'r7223', 'r7224', 'r7225', 'r7226', 'r7228',
#                'r7229', 'r7230', 'r7232', 'r7233']

# dz_location = ['r3187', 'r70571', 'r7124', 'r3198', 'r12325', 'r1951', 'r70572', 'r31', 'r12319', 'r70566', 'r12328',
#                'r1565', 'r8352', 'r70563', 'r7108', 'r3158', 'r8349', 'r82240', 'r70547', 'r3147', 'r70582', 'r8650',
#                'r7225', 'r12262', 'r70581', 'r7179', 'r23067', 'r7106', 'r12330', 'r7152', 'r7142', 'r1556', 'r70559',
#                'r3216', 'r12256', 'r3183', 'r7876', 'r8647', 'r70573', 'r7170', 'r7119', 'r7229', 'r38388', 'r7095',
#                'r70541', 'r82241', 'r12324', 'r8402', 'r7474', 'r8354', 'r7163', 'r7201', 'r3172', 'r7129', 'r70593',
#                'r7209', 'r7112', 'r1950', 'r7098', 'r7228', 'r30534', 'r7168', 'r8358', 'r3205', 'r3141', 'r7606',
#                'r70558', 'r3213', 'r3174', 'r3199', 'r7175', 'r1559', 'r1952', 'r7200', 'r7160', 'r70576', 'r70283',
#                'r12331', 'r64845', 'r3201', 'r3159', 'r7101', 'r70542', 'r3203', 'r7188', 'r7187', 'r7147', 'r7166',
#                'r8356', 'r11334', 'r7114', 'r7121', 'r1574', 'r7230', 'r12260', 'r3190', 'r7115', 'r12259', 'r33',
#                'r7117', 'r7874', 'r7207', 'r3202', 'r70545', 'r3139', 'r70551', 'r7482', 'r70553', 'r3210', 'r70556',
#                'r23069', 'r8649', 'r70575', 'r7157', 'r3211', 'r3218', 'r83344', 'r7153', 'r7208', 'r8652', 'r12333',
#                'r70594', 'r7182', 'r7192', 'r7139', 'r1953', 'r7130', 'r7156', 'r7122', 'r7605', 'r70631', 'r70578',
#                'r7176', 'r12323', 'r7883', 'r12258', 'r12226', 'r30824', 'r7104', 'r64844', 'r7177', 'r6013', 'r1562',
#                'r7180', 'r12225', 'r70284', 'r3206', 'r7211', 'r28441', 'r1575', 'r64848', 'r64843', 'r12254', 'r1568',
#                'r8351', 'r7602', 'r8653', 'r1955', 'r3138', 'r12033', 'r1557', 'r7174', 'r64803', 'r3209', 'r7144',
#                'r7094', 'r7232', 'r70527', 'r7162', 'r8399', 'r7881', 'r12326', 'r70554', 'r70557', 'r70538', 'r82421',
#                'r1563', 'r70567', 'r12321', 'r8350', 'r70565', 'r7145', 'r8401', 'r3142', 'r12327', 'r70579', 'r70564',
#                'r7120', 'r7099', 'r8347', 'r7231', 'r7204', 'r7223', 'r7131', 'r30', 'r64847', 'r7149', 'r7150',
#                'r1571', 'r7102', 'r3214', 'r1564', 'r7185', 'r3215', 'r12335', 'r7198', 'r3140', 'r12261', 'r7196',
#                'r7146', 'r67064', 'r7224', 'r70583', 'r7167', 'r7607', 'r7110', 'r12255', 'r1954', 'r70584', 'r12329',
#                'r7100', 'r3143', 'r70550', 'r3217', 'r32', 'r7181', 'r7123', 'r8355', 'r7212', 'r12257', 'r8359',
#                'r1569', 'r1949', 'r70574', 'r7125', 'r1573', 'r3207', 'r7203', 'r29', 'r7226', 'r70552', 'r7875',
#                'r7233', 'r1957', 'r7159', 'r3208', 'r3144', 'r70577', 'r70543', 'r3212', 'r7096', 'r7475', 'r3167',
#                'r7097', 'r7183', 'r12034', 'r7186', 'r3200', 'r12334', 'r7202', 'r12320', 'r7222', 'r8353', 'r8348',
#                'r3148', 'r3173', 'r7126', 'r12035', 'r1570', 'r64846', 'r7109', 'r38389', 'r1566', 'r70570', 'r1560',
#                'r28440', 'r12322', 'r3204', 'r70282', 'r7165', 'r12332', 'r70546', 'r70549', 'r8648', 'r7173', 'r70561',
#                'r7169', 'r64842', 'r38387', 'r38386', 'r7118', 'r70569', 'r70555', 'r70544', 'r70562', 'r70568',
#                'r3160', 'r1572', 'r34', 'r1567', 'r70137', 'r7480', 'r64802', 'r7171', 'r70560', 'r7178', 'r7206',
#                'r70540', 'r1956', 'r8651', 'r7882', 'r12036', 'r7194', 'r8646', 'r8357']
import json
from requests_html import HTMLSession

from bs4 import BeautifulSoup
import logging

dz_location = ['r29', 'r1949', 'r7475', 'r1560', 'r12322', 'r1556', 'r1951', 'r12321', 'r1559', 'r12225', 'r1557',
               'r1573', 'r12324', 'r12226', 'r12323', 'r3138', 'r12320', 'r12319', 'r1950',
               # r29 福田区
               'r31', 'r28441', 'r1566', 'r6013', 'r1952', 'r1954', 'r1953', 'r7474', 'r67064', 'r1567', 'r28440',
               'r30824', 'r1568', 'r12333',
               # r31 南山区
               'r12036', 'r8358', 'r8359',
               # r12036 大鹏新区
               'r30', 'r8347', 'r1563', 'r1562', 'r1574', 'r70137', 'r12330', 'r1564', 'r1565', 'r12326', 'r1575',
               'r12327', 'r12328', 'r12325', 'r3139', 'r12332', 'r12329', 'r12331', 'r23067', 'r83344',
               # r30 罗湖区
               'r32', 'r1572', 'r1571', 'r30534', 'r1955',
               # r32 盐田区
               'r12033', 'r8651', 'r64803', 'r1956', 'r70527', 'r23069', 'r8652', 'r8354',
               # r12033 龙华区
               'r12035', 'r8356',
               # r12035 坪山区
               'r34', 'r8646', 'r1957', 'r1570', 'r12335', 'r8647', 'r8357', 'r8355', 'r12334', 'r8648', 'r3141',
               'r70631',
               # r34 龙岗区
               'r33', 'r38389', 'r1569', 'r64842', 'r38388', 'r38386', 'r64843', 'r64844', 'r38387', 'r64848', 'r8649',
               'r8650', 'r64846', 'r8350', 'r8349', 'r64802', 'r8353', 'r8351', 'r8653', 'r64845', 'r3140', 'r64847',
               'r8352', 'r8348'
               # r33 宝安区
               ]


def html_from_uri(uri):
    print('html_from_uri uri: {}'.format(uri))
    try:
        if uri is None:
            return
        session = HTMLSession()
        r = session.get(uri)
        return r.html
    except Exception as e:
        print('Exception: {}'.format(e))
        return html_from_uri(uri)


def address_of_location_title(item):
    address = '深圳' + item['location'] + item['title']
    print('address_of_location_title 1: {}'.format(address))
    logging.getLogger(__name__).debug('address_of_location_title 1: ' + address)
    if '，' in address:
        address = address.split('，')[0]
    if '市中心区' in address:
        address = address.replace('市中心区', '福田区')
    # elif '中心区' in address:
    #     address = address.replace('中心区', '区')
    b = bytes(address, encoding='utf8')
    if len(b) > 84:  # 地址最多支持84个字节
        # address = bytes.decode(b[:84])
        address = address[:28]
    print('address_of_location_title 2: {}'.format(address))
    logging.getLogger(__name__).debug('address_of_location_title 2: ' + address)
    return address


def address_of_location_home(item):
    address = '深圳' + item['district'] + item['location'] + item['title']
    print('address_of_location_home 1: {}'.format(address))
    logging.getLogger(__name__).debug('address_of_location_home 1: ' + address)
    if '，' in address:
        address = address.split('，')[0]
    if '市中心区' in address:
        address = address.replace('市中心区', '福田区')
    # elif '中心区' in address:
    #     address = address.replace('中心区', '区')
    b = bytes(address, encoding='utf8')
    if len(b) > 84:  # 地址最多支持84个字节
        # address = bytes.decode(b[:84])
        address = address[:28]
    print('address_of_location_home 2: {}'.format(address))
    logging.getLogger(__name__).debug('address_of_location_home 2: ' + address)
    return address


def address_of_location(item):
    location = item['location']
    if '市中心区' in item['location']:
        location = item['location'].replace('市中心区', '福田区')
    elif '中心区' in item['location']:
        location = item['location'].replace('中心区', '区')
    print("address_of_location 0: location: {} ,item['address']: {}".format(location, item['address']))
    logging.getLogger(__name__).debug(
        "address_of_location 0: location:" + location + "  item['address']: " + item['address'])
    address = '深圳' + location + item['address']
    print('address_of_location 0: {}'.format(address))
    logging.getLogger(__name__).debug('address_of_location 0: {}'.format(address))
    if 'www' in item['address'] or item['address'] == '':
        address = '深圳' + location + item['title']
    print('address_of_location 1: {}'.format(address))
    logging.getLogger(__name__).debug('address_of_location 1: {}'.format(address))
    if '，' in address:
        address = address.split('，')[0]
    b = bytes(address, encoding='utf8')
    if len(b) > 84:  # 地址最多支持84个字节
        # address = bytes.decode(b[:84])
        address = address[:28]
    print('address_of_location 2: {}'.format(address))
    logging.getLogger(__name__).debug('address_of_location 2: {}'.format(address))
    return address


def getlocation(item):
    if item.collection in ['Hotel', 'Wedding', 'Baby']:
        address = address_of_location_title(item)
    elif item.collection in ['Home']:
        address = address_of_location_home(item)
    else:
        address = address_of_location(item)
    url = 'http://api.map.baidu.com/geocoder/v2/'
    output = 'json'
    ak = '1233467789'#换成自己的百度地图ak
    uri = url + '?' + 'address=' + address + '&output=' + output + '&ak=' + ak
    temp = html_from_uri(uri)
    soup = BeautifulSoup(temp.html, 'lxml')
    print(soup.prettify())
    logging.getLogger(__name__).debug(soup.prettify())
    my_location = json.loads(soup.find('p').text)
    print('my_location: {}'.format(my_location))
    logging.getLogger(__name__).debug('my_location: {}'.format(my_location))
    if my_location['status'] == 0:  # 服务请求正常召回
        item['lat'] = my_location['result']['location']['lat']  # 纬度
        item['lng'] = my_location['result']['location']['lng']  # 经度
        item['precise'] = my_location['result']['precise']
        # 位置的附加信息，是否精确查找。1为精确查找，即准确打点；0为不精确，即模糊打点（模糊打点无法保证准确度，不建议使用）。
        item['confidence'] = my_location['result']['confidence']
        # 可信度，描述打点准确度，大于80表示误差小于100m。该字段仅作参考，返回结果准确度主要参考precise参数。
    print('precise: {},confidence: {},lat: {},lng: {}'.format(item['precise'], item['confidence'], item['lat'],
                                                              item['lng']))
    logging.getLogger(__name__).debug(
        'precise: {},confidence: {},lat: {},lng: {}'.format(item['precise'], item['confidence'], item['lat'],
                                                            item['lng']))
    print('{},{}'.format(item['lat'], item['lng']))
    logging.getLogger(__name__).debug('{},{}'.format(item['lat'], item['lng']))
    print('{},{}'.format(item['lng'], item['lat']))
    logging.getLogger(__name__).debug('{},{}'.format(item['lng'], item['lat']))


# 把浏览器的cookies字符串转成字典
def cookies2dict(cookies):
    items = cookies.split(';')
    d = {}
    for item in items:
        kv = item.split('=', 1)
        k = kv[0]
        v = kv[1]
        d[k] = v
    return d
